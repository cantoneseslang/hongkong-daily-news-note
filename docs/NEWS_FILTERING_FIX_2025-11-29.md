# ニュースフィルタリング改善（2025年11月29日）

## 問題

1. **同じニュースが繰り返し取得される**
   - 宏福苑の火災ニュースが多数
   - 「同意の新たな基準：香港の性犯罪へのアプローチを改革」が3日間連続
   - エアバスA320のニュースが重複

2. **原因**
   - URLの正規化が不十分（`utm_source=rss_feed`などのパラメータが異なると別URLとして扱われる）
   - タイトルベースの重複チェックが弱い
   - NGワードリストに特定の繰り返しニュースが含まれていない

## 実施した修正

### 1. NGワードの追加（fetch_rss_news.py）

火災関連、性犯罪関連、エアバス関連のキーワードを追加：

```python
# 火災関連
'宏福苑', 'wang fuk court', 'wang fuk', '大埔大火', '大埔火災', 'tai po fire',
'宏福苑大火', '宏福苑火災', 'deadly fire', 'fire-ravaged',
'fire climbs', 'death toll', 'mourning period', 'fire displaced',
'fire survivor', 'blaze', 'inferno', '死裡逃生', '受困', '火警',
'火災', 'donation', '援助基金', 'relief fund', '受災', 'disaster relief',

# 性犯罪関連
'sexual crime', '性犯罪', 'consent reform', '同意の新たな基準',
'reforming hong kong approach sexual crimes', 'new test consent',

# エアバス関連
'airbus a320', 'エアバスa320', 'a320 software', 'a320型機',
'emergency grounding', '緊急運航停止', '約6000機'
```

### 2. タイトル重複チェックの強化

`_is_duplicate_content()` メソッドを強化：

- **キーフレーズ検出**: 特定のキーワード（airbus, sexual_crime, fire等）を抽出
- **厳格なマッチング**: 2つ以上のキーフレーズが一致したら重複とみなす
- **類似度計算の改善**: 
  - 短いタイトル（3語以下）: 全単語一致が必要
  - 中程度のタイトル（4-6語）: 70%以上一致
  - 長いタイトル（7語以上）: 60%以上一致
- **中国語・日本語対応**: Unicode範囲での句読点除去を追加

### 3. URL正規化の改善

`_normalize_url()` メソッドを強化：

- クエリパラメータの完全除去
- 末尾スラッシュの統一
- 大文字小文字の統一（`.lower()`）
- Google News URLの特別処理

### 4. 処理済みURL履歴のリセット

- 古い履歴（2238行）をバックアップ
- 新しい空の履歴ファイルを作成
- これにより、新鮮なニュースが取得可能に

## テスト方法

```bash
cd /Users/sakonhiroki/hongkong-daily-news-note
source venv/bin/activate
python3 fetch_rss_news.py
```

## 期待される結果

- 火災関連ニュースが除外される
- 性犯罪関連の繰り返しニュースが除外される
- エアバスA320の重複ニュースが除外される
- より多様な香港ニュースが取得される
- 経済、金融、社会、文化などのバランスの取れたニュースが取得される

## 注意事項

### NGワードの一時的な追加

現在のNGワードリストに追加した以下のキーワードは、ニュースサイクルが変わったら削除することを推奨：

- 火災関連（1-2週間後に削除）
- 性犯罪関連（再度記事が出なければ削除）
- エアバス関連（問題解決後に削除）

### 処理済みURL履歴

- `processed_urls.json`は60日間の履歴を保持
- 定期的にクリーンアップされる
- バックアップは`processed_urls.json.backup`に保存

## 今後の改善案

1. **機械学習ベースの重複検出**: タイトルの埋め込みベクトルを使用した類似度計算
2. **トピッククラスタリング**: 同じトピックのニュースをグループ化して、1つだけ選択
3. **ニュースの鮮度スコア**: 新しいニュースを優先的に選択
4. **ユーザーフィードバック**: 特定のニュースカテゴリの除外設定を可能にする

