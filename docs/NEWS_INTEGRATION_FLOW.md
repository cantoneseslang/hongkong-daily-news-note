# ニュース記事生成の統合プロセス

## 📊 全体フロー図

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 1: ニュース取得 (fetch_rss_news.py)                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │  Phase 1-1: Webスクレイピング            │
        │  (scrape_news_list.py)                   │
        └─────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
  ┌──────────┐        ┌──────────┐        ┌──────────┐
  │Google News│        │   HK01   │        │  明報    │
  │   HK      │        │          │        │  am730   │
  │ (106件)   │        │  (47件)  │        │  (0件)   │
  └──────────┘        └──────────┘        └──────────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │  Phase 1-2: RSSフィード取得              │
        └─────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
  ┌──────────┐        ┌──────────┐        ┌──────────┐
  │  SCMP    │        │  RTHK    │        │  Yahoo   │
  │  (10件)  │        │  (5件)   │        │  (0件)   │
  └──────────┘        └──────────┘        └──────────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │  重複除去・フィルタリング                 │
        │  - URL重複チェック                       │
        │  - タイトル重複チェック                   │
        │  - 24時間以内フィルタリング               │
        │  - 香港関連度チェック                     │
        │  - 禁止コンテンツフィルタリング           │
        └─────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │  記事全文取得 (scrape_article.py)        │
        │  - 各記事のURLから本文を取得              │
        │  - 失敗時はdescriptionを使用              │
        └─────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │  保存: rss_news_YYYY-MM-DD_HH-MM-SS.json │
        │  {                                      │
        │    "fetch_time": "...",                  │
        │    "total_count": 150,                   │
        │    "news": [...],                        │
        │    "weather": {...}                      │
        │  }                                       │
        └─────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  Phase 2: 記事生成 (generate_article.py)                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │  ニュースデータ読み込み                   │
        │  rss_news_*.json を読み込む               │
        └─────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │  事前処理 (preprocess_news)              │
        │  1. 重複除外                             │
        │  2. カテゴリー分類                       │
        │  3. バランス選択                         │
        │     - カテゴリー別制限                  │
        │     - ソース別制限                       │
        │     - トピック重複チェック               │
        └─────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │  LLMで記事生成 (Grok/Gemini/Claude)      │
        │  - 日本語翻訳                            │
        │  - Markdown形式で記事生成                │
        │  - 引用元・リンクを追加                  │
        └─────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │  保存: hongkong-news_YYYY-MM-DD.md       │
        │  # 香港デイリーニュース YYYY年MM月DD日   │
        │                                          │
        │  ## 天気情報                             │
        │  ...                                     │
        │                                          │
        │  ## ニュース                             │
        │  ### 記事タイトル1                       │
        │  ...                                     │
        │  **引用元**: SCMP                        │
        │  **リンク**: https://...                 │
        │                                          │
        │  ### 記事タイトル2                       │
        │  ...                                     │
        └─────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  Phase 3: 投稿 (GitHub Actions + note.com)                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │  GitHub Actions                          │
        │  1. 記事をGitHubにコミット・プッシュ      │
        │  2. note.comに自動投稿                   │
        └─────────────────────────────────────────┘
```

## 🔄 詳細な統合プロセス

### 1. ニュース取得フェーズ (`fetch_rss_news.py`)

#### Phase 1-1: Webスクレイピング
- **`scrape_news_list.py`** を呼び出し
- **Google News HK**: 106件（24時間以内）
- **HK01**: 47件
- **明報・am730**: 0件（ネットワークエラー）

#### Phase 1-2: RSSフィード取得
- **SCMP**: 10件
- **RTHK**: 5件
- **Yahoo HK**: 0件（フィルタ済み）
- **Google News HK RSS**: 33件（24時間以内）
- **その他**: HKFP, HKET等

#### 統合処理
```python
# fetch_rss_news.py の fetch_all_rss() メソッド

1. スクレイピング結果を統合
   - 重複チェック（URL、タイトル）
   - 24時間以内フィルタリング
   - 香港関連度チェック
   - 禁止コンテンツフィルタリング

2. RSSフィード結果を統合
   - 同じ重複チェック・フィルタリングを適用
   - スクレイピング結果と重複しない記事のみ追加

3. 記事全文取得
   - scrape_article.py で各記事のURLから本文を取得
   - 失敗時はdescriptionを使用

4. JSONファイルとして保存
   - daily-articles/rss_news_YYYY-MM-DD_HH-MM-SS.json
```

### 2. 記事生成フェーズ (`generate_article.py`)

#### 事前処理 (`preprocess_news`)
```python
1. 重複除外
   - URL重複
   - タイトル類似度チェック（過去3日間）

2. カテゴリー分類
   - ビジネス・経済
   - 政治・行政
   - 社会・その他
   - テクノロジー
   - 文化
   - スポーツ

3. バランス選択
   - 目標: 40件
   - カテゴリー別制限を適用
   - ソース別制限を適用
   - トピック重複を避ける
```

#### LLM記事生成
```python
# GrokArticleGenerator.generate_article()

1. ニュースデータをプロンプト形式に整形
2. システムプロンプト + ユーザープロンプトを構築
3. LLM APIを呼び出し（Grok/Gemini/Claude）
4. Markdown形式の記事を生成
5. 天気情報を統合
6. ファイルとして保存
```

### 3. 投稿フェーズ (GitHub Actions)

```yaml
1. fetch_rss_news.py を実行
   → rss_news_*.json を生成

2. generate_article.py を実行
   → hongkong-news_YYYY-MM-DD.md を生成

3. GitHubにコミット・プッシュ
   → 記事をリポジトリに保存

4. note.comに自動投稿
   → 公開記事として投稿
```

## 📈 期待される結果

### 取得記事数
- **スクレイピング**: 106件（Google News HK）+ 47件（HK01）= 153件
- **RSSフィード**: 約50件
- **合計**: 約200件

### フィルタリング後
- **24時間以内**: 約150件
- **香港関連**: 約120件
- **重複除外後**: 約100件

### 最終記事
- **選択記事数**: 40件（バランス選択）
- **カテゴリー別**: バランス良く配分
- **形式**: Markdown形式の日本語記事

## 🔧 設定ファイル

### `fetch_rss_news.py`
- RSSフィードURL設定
- フィルタリング条件
- 処理済みURL履歴管理

### `generate_article.py`
- LLM API設定（Grok/Gemini/Claude）
- カテゴリー制限設定
- 記事選択ロジック

### `.github/workflows/daily-news.yml`
- 実行スケジュール（毎日HKT 06:00）
- 実行順序
- エラーハンドリング

## 🎯 改善ポイント

1. **記事数増加**: Google News HKスクレイピングで106件追加
2. **24時間フィルタリング**: 最新記事のみを取得
3. **重複除外**: URL・タイトル・トピックの3段階チェック
4. **バランス選択**: カテゴリーとソースのバランスを考慮

