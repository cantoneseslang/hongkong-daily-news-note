# 香港ニュース自動生成システム 完全記録

## 2025-10-30 リンク整形・天気翻訳 安定化（要約）

- 症状: noteでリンクにならない／引用元とリンクが1行に結合、あるいは同一段落化。
- 原因: LLM出力の揺れ＋旧後処理の `[URL](URL)` ラップで、URLが独立行にならないケースが残った。
- 対応:
  - 引用部は「引用元行＋空行＋URL単独行」に強制（274fbe4, 1bf177c）。
  - Markdownリンク解除→プレーンURLへ統一。
  - 天気はLLM一発翻訳に統一（c4ba273）。
- 仕様: `**引用元**: ソース名` → 空行 → `https://…`（URLだけの独立行）。
- 再発防止: 保存直前バリデーション＋Actionsでのgrep検査を実運用に追加。


## 📋 システム概要

香港の最新ニュースを自動収集し、日本語記事として生成・noteに投稿する完全自動化システムです。

### 🎯 主要機能
- **RSSフィード収集**: 7つの香港ニュースソースから最新ニュースを取得
- **重複排除**: 日付フィルタリング + URL重複チェック
- **天気情報**: 香港天文台から天気予報を取得・日本語翻訳
- **記事生成**: Grok APIを使用して日本語記事を生成
- **自動投稿**: note.comへの自動投稿

---

## 🔧 システム構成

### ファイル構成
```
hongkong-daily-news-note/
├── fetch_rss_news.py          # RSS収集・天気情報取得
├── generate_article.py        # 記事生成
├── post_to_note_browser.js    # note自動投稿
├── requirements.txt           # 依存関係
├── daily-articles/            # 生成ファイル保存
│   ├── rss_news_*.json       # 収集データ
│   ├── hongkong-news_*.md    # 生成記事
│   └── processed_urls.json   # 重複排除用URL履歴
└── venv/                     # 仮想環境
```

---

## 📰 RSSフィード収集システム

### 対応RSSフィード（7つ）
```python
self.rss_feeds = {
    'scmp_hongkong': 'https://www.scmp.com/rss/2/feed',
    'rthk_news': 'https://rthk.hk/rthk/news/rss/e_expressnews_elocal.xml',
    'yahoo_hk': 'http://hk.news.yahoo.com/rss/hong-kong',
    'google_news_hk': 'http://news.google.com.hk/news?pz=1&cf=all&ned=hk&hl=zh-TW&output=rss',
    'chinadaily_hk': 'http://www.chinadaily.com.cn/rss/hk_rss.xml',
    'hkfp': 'https://www.hongkongfp.com/feed/',
    'hket_hk': 'https://www.hket.com/rss/hongkong',
}
```

### 天気情報RSSフィード（4つ）
```python
self.weather_feeds = {
    'weather_warning': 'https://rss.weather.gov.hk/rss/WeatherWarningSummaryv2_uc.xml',
    'weather_forecast': 'https://rss.weather.gov.hk/rss/LocalWeatherForecast_uc.xml',
    'current_weather': 'https://rss.weather.gov.hk/rss/CurrentWeather_uc.xml',
    'nine_day_forecast': 'https://rss.weather.gov.hk/rss/SeveralDaysWeatherForecast_uc.xml',
}
```

### 重複排除システム
- **URL重複チェック**: `processed_urls.json`で過去30日間のURL履歴を管理
- **日付フィルタリング**: 今日・昨日のニュースのみ収集
- **自動保存**: 処理済みURLを自動保存

---

## 🤖 記事生成システム

### Grok API仕様
- **API**: xAI Grok API
- **モデル**: 最新のGrokモデル
- **出力形式**: JSON形式の記事データ

### 記事生成プロンプト
```python
system_prompt = """あなたは香港のニュースを日本語で要約する専門ライターです。

【記事構成】
各ニュースは以下のMarkdown形式で記載（番号なし）:

### [ニュースタイトル]

[Full Contentを全文翻訳、段落は空白行で区切る]

**引用元**: [source名], [日付]  
**リンク**: [完全なURL]  
**備考**: [重要性や日本との関連性を1文で]

---

### [次のニュースタイトル]

[Full Contentを全文翻訳]

**引用元**: [source名], [日付]  
**リンク**: [完全なURL]  
**備考**: [重要性や日本との関連性を1文で]

【重要】
- 番号（1. 2. など）は絶対に使用しない
- 各ニュースのタイトルは「### タイトル名」形式で小見出しにする
- ニュース間は「---」で区切る
- 引用元、リンク、備考は「**項目名**:」形式で太字にする
- 各ニュースのFull Contentは完全に日本語に翻訳する
- ニュースの内容は正確に翻訳し、事実を歪めない

【出力形式】
必ず以下のJSON形式で返してください。JSON以外の文字は一切含めないでください：
{
  "title": "毎日AIピックアップニュース(2025年10月17日)",
  "lead": "",
  "body": "上記フォーマットのMarkdown記事",
  "tags": "香港,ニュース,最新,情報,アジア"
}

【重要】JSON形式のみで回答し、他の説明文や追加テキストは一切含めないでください。"""
```

### 記事数設定
- **記事数**: 20件以上（システムプロンプトで「必ず20件選び、20件未満は不可」と指定）
- **重複排除**: 処理済みURLをチェックして新しいニュースのみ使用

---

## 🌤️ 天気情報システム

### 天気情報処理フロー
1. **RSS取得**: 香港天文台の4つのRSSフィードから天気情報を取得
2. **日本語翻訳**: Google Translate APIを使用して中国語・広東語から日本語に翻訳
3. **フィルタリング**: 「現時並無警告生效」などの不要情報をフィルター
4. **記事配置**: 記事の最初に天気予報セクションを配置

### 翻訳処理
```python
def _translate_weather_text(self, text: str) -> str:
    """天気情報のテキストを中国語・広東語から日本語に翻訳"""
    try:
        import requests
        import json
        
        # Google Translate APIを使用して翻訳
        url = "https://translate.googleapis.com/translate_a/single"
        params = {
            'client': 'gtx',
            'sl': 'zh',  # 中国語から
            'tl': 'ja',  # 日本語へ
            'dt': 't',
            'q': text
        }
        
        response = requests.get(url, params=params, timeout=10)
        if response.status_code == 200:
            result = response.json()
            if result and len(result) > 0 and len(result[0]) > 0:
                translated = ''.join([item[0] for item in result[0] if item[0]])
                return translated.strip()
        
        return text  # 翻訳に失敗した場合は元のテキストを返す
        
    except Exception as e:
        print(f"⚠️  天気翻訳エラー: {e}")
        return text  # エラーの場合は元のテキストを返す
```

### 天気情報フィルタリング
```python
# 「現時並無警告生效」をフィルター
if title and "現時並無警告生效" not in title:
    weather_section += f"### 天気警報\n\n{title}\n\n"
    if desc and "現時並無警告生效" not in desc:
        weather_section += f"{desc}\n\n"
```

---

## 📝 記事構成・フォーマット

### 最終記事構成
```markdown
# 毎日AIピックアップニュース(2025年10月17日)

## 本日の香港の天気
### 天気予報
[翻訳された天気予報内容]*情報提供: 香港天文台*

---

### [ニュースタイトル1]
[完全な日本語翻訳内容]

**引用元**: [source名], [日付]  
**リンク**: [完全なURL]  
**備考**: [重要性や日本との関連性を1文で]

---

### [ニュースタイトル2]
[完全な日本語翻訳内容]

**引用元**: [source名], [日付]  
**リンク**: [完全なURL]  
**備考**: [重要性や日本との関連性を1文で]

...（20件以上）

---

**タグ**: 香港,ニュース,最新,情報,アジア

**生成日時**: 2025年10月17日 08:48
```

### 記事フォーマット仕様
- **タイトル**: `毎日AIピックアップニュース(YYYY年MM月DD日)`
- **天気予報**: 記事の最初に配置、改行なしで一行表示
- **ニュース記事**: `### タイトル`形式の小見出し
- **引用情報**: `**引用元**`, `**リンク**`, `**備考**`形式で太字
- **区切り**: ニュース間は`---`で区切り
- **記事数**: 20件以上

---

## 🚀 自動投稿システム

### Playwright自動化
- **ブラウザ**: Chromium
- **認証**: `storageState`を使用したログイン状態保持
- **投稿先**: note.com

### 投稿処理フロー
```javascript
// 1. note.comにログイン
await page.goto('https://note.com/login');

// 2. 新規記事作成ページに移動
await page.goto('https://editor.note.com/new');

// 3. タイトル入力
await page.fill('input[placeholder*="タイトル"]', title);

// 4. 本文入力
await page.fill('textarea[placeholder*="本文"]', body);

// 5. 下書き保存
await page.click('button[data-testid="save-draft"]');
```

### 認証状態管理
- **ファイル**: `/Users/sakonhiroki/.note-state.json`
- **機能**: ログイン状態を永続化
- **自動更新**: 投稿時に自動更新

---

## 🔄 完全自動化フロー

### 実行コマンド
```bash
# 1. ニュース収集
source venv/bin/activate
python fetch_rss_news.py

# 2. 記事生成
python generate_article.py daily-articles/rss_news_*.json

# 3. note投稿
node post_to_note_browser.js daily-articles/hongkong-news_*.md bestinksalesman Hsakon0419
```

### 処理フロー詳細
1. **RSS収集** (`fetch_rss_news.py`)
   - 7つのRSSフィードからニュース取得
   - 重複排除（URL履歴チェック）
   - 日付フィルタリング（今日・昨日）
   - 天気情報取得・翻訳
   - JSON形式で保存

2. **記事生成** (`generate_article.py`)
   - Grok APIで記事生成
   - JSONパース処理
   - 天気情報を記事の最初に配置
   - Markdown形式で保存

3. **自動投稿** (`post_to_note_browser.js`)
   - Playwrightでブラウザ自動化
   - note.comにログイン
   - 記事を投稿
   - 下書きURLを返却

---

## 🛠️ 技術仕様

### 使用技術
- **Python 3.x**: メイン処理
- **feedparser**: RSS解析
- **requests**: HTTP通信
- **Node.js**: 自動投稿
- **Playwright**: ブラウザ自動化
- **Grok API**: 記事生成
- **Google Translate API**: 天気情報翻訳

### 依存関係 (`requirements.txt`)
```
feedparser>=6.0.0
requests>=2.25.0
```

### 環境設定
- **仮想環境**: `venv/`
- **認証ファイル**: `~/.note-state.json`
- **データ保存**: `daily-articles/`

---

## 📊 収集データ統計

### ニュース収集実績（2025年10月17日）
- **総ニュース数**: 53件
- **フィルタ済み**: 150件（重複排除）
- **記事生成**: 21件
- **天気情報**: 4件（香港天文台）

### RSSフィード別収集数
- **SCMP**: 10件
- **RTHK**: 2件
- **Yahoo News HK**: 20件
- **Google News HK**: 14件
- **China Daily HK**: 0件
- **Hong Kong Free Press**: 4件
- **HKET**: 3件

---

## 🔧 トラブルシューティング

### よくある問題と解決方法

#### 1. JSONパースエラー
```
⚠️  JSONパースエラー: Invalid control character at: line 4 column 58
```
**原因**: Grok APIレスポンスに制御文字が含まれる
**解決**: 制御文字除去処理を追加
```python
# 制御文字を完全に除去
json_str = ''.join(char for char in json_str if ord(char) >= 32 or char in '\n\t')
```

#### 2. RSSフィードエラー
```
❌ RSSフィードエラー: 404 Not Found
```
**原因**: RSSフィードURLが変更または削除
**解決**: 新しいRSSフィードURLに更新

#### 3. note投稿エラー
```
❌ エラー発生: keyboard.type: Target page, context or browser has been closed
```
**原因**: ブラウザセッションがタイムアウト
**解決**: 再投稿またはログイン状態の確認

#### 4. 天気翻訳エラー
```
⚠️  天気翻訳エラー: [Error details]
```
**原因**: Google Translate APIの一時的なエラー
**解決**: エラーハンドリングで元のテキストを返却

---

## 📈 システム改善履歴

### 主要な改善点

#### 1. 記事数変更
- **変更前**: 10件 → **変更後**: 20件以上
- **実装**: システムプロンプトで「必ず20件選び、20件未満は不可」と指定

#### 2. 天気情報翻訳
- **変更前**: 中国語・広東語のまま表示
- **変更後**: Google Translate APIで日本語翻訳
- **実装**: `_translate_weather_text()`関数を追加

#### 3. 記事構成変更
- **変更前**: ニュース記事 → 天気情報
- **変更後**: 天気情報 → ニュース記事
- **実装**: `save_article()`関数で配置順序を変更

#### 4. タイトル変更
- **変更前**: `毎日AIスラングピックアップニュース`
- **変更後**: `毎日AIピックアップニュース`
- **実装**: システムプロンプトのタイトル部分を変更

#### 5. 改行削除
- **変更前**: 天気予報に余分な改行が多数
- **変更後**: 改行なしで一行表示
- **実装**: Markdown生成時の改行文字を削除

#### 6. リード文削除
- **変更前**: 「本日の香港ニュースを正確な情報源と共にお届けします。」
- **変更後**: リード文なし
- **実装**: システムプロンプトのleadを空文字に変更

---

## 🎯 システム特徴

### 完全自動化
- **人手不要**: ニュース収集から投稿まで完全自動
- **毎日実行可能**: cron等で定期実行可能
- **エラー処理**: 各種エラーに対する自動回復機能

### 高品質記事
- **翻訳精度**: Grok APIによる高品質な日本語翻訳
- **情報源明記**: 各記事に引用元・リンク・備考を記載
- **天気情報**: 香港天文台からの正確な天気予報

### 重複排除
- **URL管理**: 過去30日間のURL履歴を管理
- **日付フィルタ**: 最新のニュースのみ収集
- **効率的**: 無駄な処理を排除

### 拡張性
- **RSS追加**: 新しいRSSフィードを簡単に追加可能
- **翻訳対応**: 他言語への翻訳も可能
- **投稿先変更**: 他のプラットフォームへの投稿も対応可能

---

## 📋 運用ガイド

### 日常運用
1. **毎日実行**: 朝にニュース収集・記事生成・投稿を実行
2. **ログ確認**: エラーログを確認して問題があれば対応
3. **URL履歴管理**: `processed_urls.json`の容量を定期的に確認

### メンテナンス
1. **RSSフィード確認**: 月1回程度、各RSSフィードの動作確認
2. **認証状態更新**: note.comのログイン状態が切れた場合は再ログイン
3. **依存関係更新**: 定期的なパッケージ更新

### 監視項目
- **収集ニュース数**: 異常に少ない場合はRSSフィードを確認
- **記事生成時間**: Grok APIの応答時間を監視
- **投稿成功率**: note.comへの投稿成功率を監視

---

## 🔮 今後の拡張計画

### 機能拡張
1. **多言語対応**: 英語・中国語での記事生成
2. **AI画像生成**: 記事用のサムネイル画像自動生成
3. **SNS投稿**: Twitter・Facebook等への自動投稿
4. **音声合成**: 記事の音声版生成

### 技術改善
1. **API最適化**: より効率的なAPI使用
2. **エラー処理強化**: より堅牢なエラーハンドリング
3. **監視機能**: システム状態のリアルタイム監視
4. **バックアップ**: データの自動バックアップ

---

## 📞 サポート情報

### 開発環境
- **OS**: macOS (darwin 24.6.0)
- **Shell**: /bin/zsh
- **Python**: 3.x
- **Node.js**: 最新版

### 認証情報
- **note.com**: bestinksalesman / Hsakon0419
- **Grok API**: xAI API Key使用
- **Google Translate**: 無料API使用

### ファイルパス
- **プロジェクト**: `/Users/sakonhiroki/hongkong-daily-news-note`
- **認証状態**: `/Users/sakonhiroki/.note-state.json`
- **生成ファイル**: `daily-articles/`

---

## 📝 まとめ

この香港ニュース自動生成システムは、完全自動化された高品質なニュース配信システムです。

### 主要な成果
- **完全自動化**: 人手を介さない記事生成・投稿
- **高品質**: Grok APIによる正確な日本語翻訳
- **効率性**: 重複排除による無駄のない処理
- **拡張性**: 将来の機能追加に対応可能な設計

### 技術的特徴
- **RSS収集**: 7つの香港ニュースソースから最新情報を取得
- **AI翻訳**: 高品質な日本語記事生成
- **天気情報**: 香港天文台からの正確な天気予報
- **自動投稿**: note.comへの完全自動投稿

このシステムにより、香港の最新ニュースを効率的に日本語で配信することが可能になりました。

---

## 🎯 note.com自動投稿システム（最新版）

### 目次自動挿入機能
**2025年10月22日実装完了**

#### 実装内容
1. **タイトル入力後、すぐに目次を挿入**
   - 本文エリアに入った直後（最初の空行）で目次挿入
   - `+`ボタン → 「目次」ボタンをクリック
   - 目次挿入後に`Enter`で次の行に移動

2. **本文入力**
   - 最初の空行はスキップ（目次挿入済み）
   - 天気情報から各ニュース記事を順次入力

3. **表示順序**
   ```
   1. タイトル
   2. 目次（折りたたみ可能）
   3. 本日の香港の天気
   4. 各ニュース記事
   5. タグ・生成日時
   ```

#### 技術的ポイント
- **note_auto_post.js**:
  - `tocInsertLine`を0行目（最初の空行）で検出
  - 本文入力前に目次を挿入
  - `shouldInsertToc`フラグで二重挿入を防止
  
- **generate_article.py**:
  - タイトル直後に空行を1つ生成（目次挿入用）
  - 天気情報セクションの後に改行を追加
  - 区切り線（`---`）を削除

#### テスト結果
- ✅ 6行のテスト記事: 成功
- ✅ 192行の実際の記事: 成功
- ✅ 目次が正しくタイトル直後に表示
- ✅ 目次から各セクションへのリンクが機能

---

*最終更新: 2025年10月22日*
*システムバージョン: 2.0 - 目次自動挿入機能実装*






